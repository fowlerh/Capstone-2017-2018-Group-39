#!/bin/bash
pastdate=$(<lasttime)
echo $(date +"%Y-%m-%d %T") > lasttime
mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `Recipient`,`Body` FROM `Messages` WHERE `DBCreateDate` >= "$(pastdate)"' --skip-column-names -B > newmessages
if (( $(wc -c newfile | cut -f1 -d" ") == 0 )) 
	then 
		while IFS='' read -r line || [[ -n "$line" ]]; do
			token=( $line )
			#token[0] is the group it was sent to
			#token[1] is the message body
			echo "$(date)  ---  Sending message to ${token[0]}. Message body: ${token[@]:1}" >> emaillog.file
			groupid=$(mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `GroupsTableID` FROM `Groups` WHERE `GroupName` = "${token[0]}"' --skip-column-names -B)
			usersingroup=$(mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `UsersTableID` FROM `GroupsAndUsers` WHERE `GroupsTableID` = "${groupid}"' --skip-column-names -B)
			
			for i in "${useringroup[@]}"
			do
				emailaddress=$(mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `EmailAddress` FROM `Users` WHERE `UsersTableID` = "${i}"' --skip-column-names -B)
				emailenabled=$(mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `ReceiveEmails` FROM `Users` WHERE `UsersTableID` = "${i}"' --skip-column-names -B)
				if [${emailenabled} -eq 1]
				then
					mailx -s “New ConnectBasket Messages” $emailaddress < message.txt
				fi
			done
		done < newmessages
fi



mysql -u root -pHealthydogsandcats -e 'USE ConnectBasket; SELECT `UsersTableID` FROM `GroupsAndUsers` WHERE `GroupsTableID` = "22"' --skip-column-names -B
